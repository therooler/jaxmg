name: Build jaxmg wheel (CUDA) with cached libs

on:
  push:
    branches: [ dev ]
  pull_request:
    paths:
      - ".github/workflows/build-wheel.yml"
      - "pyproject.toml"
      - "CMakeLists.txt"
      - "src/**"
  workflow_dispatch:

jobs:
  build-wheel:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
    strategy:
      fail-fast: false
      matrix:
        include:
          - python_version: "3.11"
            python_abi: "cp311-cp311"
          - python_version: "3.12"
            python_abi: "cp312-cp312"
          - python_version: "3.13"
            python_abi: "cp313-cp313"
          - python_version: "3.14"
            python_abi: "cp314-cp314"  # may not exist yet in this image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1) Restore / create cache for CUDA libs
      - name: Cache CUDA libs
        id: cache-cuda
        uses: actions/cache@v4
        with:
          path: src/jaxmg/bin
          key: >
            ${{ runner.os }}-cuda-
            ${{ hashFiles(
              'CMakeLists.txt',
              'src/cuda/**',
              'cmake/**'
            ) }}

      # 2) Only build CUDA libs if cache miss
      - name: Build CUDA libs
        if: steps.cache-cuda.outputs.cache-hit != 'true'
        uses: ./.github/actions/build-cuda-libs
        # or inline your build script here if you prefer

      # Did we rebuild?
      - name: Show whether CUDA libs were rebuilt
        run: |
          if [ "${{ steps.cache-cuda.outputs.cache-hit }}" = "true" ]; then
            echo "Using cached CUDA libs"
          else
            echo "CUDA libs rebuilt"
          fi
          ls -la src/jaxmg/bin || echo "No bin directory?"

      # 3) Set up Python & build wheel
      - name: Build wheel with Python ${{ matrix.python_version }}
        run: |
          set -ex
          PY="/opt/python/${{ matrix.python_abi }}/bin/python"

          echo "Using Python at: $PY"
          "$PY" -m pip install --upgrade pip build
          "$PY" -m build --wheel --outdir "dist-${{ matrix.python_abi }}"


      # 4) Inspect wheel
      - name: Show wheel contents
        run: |
          ls -lh "dist-${{ matrix.python_abi }}/"
          for wheel in dist-${{ matrix.python_abi }}/*.whl; do
            echo "=== $wheel ==="
            unzip -l "$wheel" | grep "\.so$" || echo "No .so files found"
          done

      # 5) Upload wheel(s) for this Python version
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: jaxmg-wheel-${{ matrix.python_abi }}-${{ github.sha }}
          path: dist-${{ matrix.python_abi }}/*.whl
          retention-days: 30
